<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../favicon.ico">

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    body,h1,h2,h3,h4,h5,h6 {font-family: "Lato", sans-serif}
    .w3-bar,h1,button {font-family: "Montserrat", sans-serif}
    .fa-anchor,.fa-coffee {font-size:200px}
  </style>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>

  <!-- java script -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

  <!-- Leaflet JS (after the CSS!) -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""></script>

  <script src="/static/dist/leaflet.polylineDecorator.js"></script>
  <script type="text/javascript" src="/static/js/lmap.js"></script>

  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-2.2.1.min.js"
          crossorigin="anonymous"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.2.1.min.js"
          crossorigin="anonymous"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.2.1.min.js"
          crossorigin="anonymous"></script>

  <title>Plan-It Results!</title>

  <!-- Bootstrap core CSS -->
  <link href="/static/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="/static/css/bootstrap-template.css" rel="stylesheet">

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>


<div class="w3-top">
  <div class="w3-bar w3-red w3-card w3-left-align w3-large">
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-red" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
    <a href="#" class="w3-bar-item w3-button w3-padding-large w3-white">Reset Parameters and Choose Another Route</a>
    <a href="https://github.com/aemerick/planit" target="_blank" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Source Code</a>
    <a href="https://github.com/aemerick/autotrail_app" target="_blank" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">App Source Code</a>
    <a href="{{url_for('aboutme')}}" target="_blank" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white"> About </a>
  </div>

  <!-- Navbar on small screens -->
  <div id="navDemo" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
    <a href="https://github.com/aemerick/planit" target="_blank" class="w3-bar-item w3-button w3-padding-large">Code</a>
    <a href="https://github.com/aemerick/autotrail_app" target="_blank" class="w3-bar-item w3-button w3-padding-large">App Code</a>
    <a href="{{url_for('aboutme')}}" target="_blank" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white"> About </a>
  </div>
</div>

<header class="w3-container w3-red w3-center" style="padding:64px 0px">
    <div class="w3-content">
      <h1 class="w3-margin w3-xxlarge">Plan-It Trails</h1>
   </div>
   </div>
</header>


  <div class="w3-row-padding w3-light-grey w3-padding-64 w3-container">
    <div class="w3-content">
      <div class="w3-twothird w3-left">
    <!--here's the input container so you can query after output is served-->
          <div id="outmap" style=" position: relative;
                                   top: 0px;
                                   left: 0px;
                                   bottom: 0;
                                   right: 0;
                                   width: 900px;
                                   height: 500px;
                                   overflow: auto;"></div>

      </div> <!-- 2/3 center for map -->

      <div class="w3-onethird w3-left", id="profile_plot">

      <div class="starter-template">
          <h2>Results:</h2>
          <h5 class="w3-padding-8">Here are your routes! Click on the GPX links to download a GPX file for each route!</h5>
      </div>
        <button id="clearmap" class="btn btn-s btn-default" onclick="clearMap()">Clear Map</button></br>
        <table class="table table-hover">
        <tr><th> Plot </br> Route</th><th>Distance ({{du}})</th><th>Elev. + ({{eu}})</th><th>Elev. - ({{eu}})</th>
            <th>Max Elev. ({{eu}})</th><th>Min Elev. ({{eu}})</th><th>Max Grade (%)</th><th>Min Grade (%)</th><th> % Repeated</th>
            <th>Download Link</th></tr>
        {% for trail in trailroutes %}
        <tr><td><button id="routebutton{{trail['route']}}" class="btn btn-xs btn-default" onclick="displayRoute({{trail['route']}})">{{ trail['route'] }}</button></td>

          <td>{{ trail['distance']}}</td><td> {{ trail['elevation_gain'] }}</td><td> {{ trail['elevation_loss'] }}</td>
                 <td>{{trail['max_altitude']}}</td><td>{{trail['min_altitude']}}</td><td>{{trail['max_grade']}}</td><td>{{trail['min_grade']}}</td>
                 <td>{{trail['repeated_percent']}}</td>
                 <td><a href="/button/dowload_gpx?val={{trail['route']}}" download="PlanIt_route_{{trail['route']}}.xml.gpx">GPX</button></td>
                </tr>
        {% endfor %}
        </table>


      </div>

    </div>
  </div>

  <div class="w3-row-padding w3-padding-64 w3-container">
    <div class="w3-content">
      <div class="w3-twothird">


                 <script>
                 fetch('/model_output/profile_plot')
                     .then(function(response) { return response.json() })
                     .then(function(item) { return Bokeh.embed.embed_item(item, "profile_plot") })
                 </script>

    </div><!-- /.container -->
  </div><!-- /.container -->
</div><!-- /.container -->



  <script>

      function decodeHtml(html) {
          var txt = document.createElement("textarea");
          txt.innerHTML = html;
          return txt.value;
      }

       var outmap = L.map('outmap').setView([{{startlat}},{{startlng}}], 12);

         L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
           attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
         }).addTo(outmap);

    //}

    /* Define arrays to hold data for plotting trails and routes */
    if (typeof trail_points === 'undefined' || trail_points === null){
      var trail_points = [];
    }

    /* Make a local container for the route polylines */
    if (typeof rlines === 'undefined' || rlines === null){
      var rlines = [];
      for (var i = 0; i < {{numroutes}}; i++){ // since we only get one at a time
        rlines.push(-1);
      }
    }

    if (typeof rline_layer === 'undefined' || rline_layer === null){
      var rline_layer = [];
      for (var i = 0; i < {{numroutes}}; i++){
        rline_layer.push(-1);
      }
    }

    if (typeof rline_dec === 'undefined' || rline_dec === null){
      var rline_dec = [];
      for (var i = 0; i < {{numroutes}}; i++){
        rline_dec.push(-1);
      }
    }


    /* Functions to make POST to get route tracks to display. stores
       locally as to NOT have to refresh */
    function displayRoute(trailnum)
    {

      function plotRoute(index){
        const line_colors = ['#1f78b4', '#33a02c', '#e31a1c','#ff7f00','#6a3d9a',
                           '#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f','#cab2d6'];

        rline_layer[index] = L.polyline(rlines[index]);
        rline_layer[index].setStyle( {'color' : line_colors[index],
                            'weight' : 4});
        rline_layer[index].addTo(outmap);

        rline_dec[index] = L.polylineDecorator(rline_layer[index], {
                                               patterns: [
                                                   {offset: 0, repeat: 50,
                                                    symbol: L.Symbol.arrowHead({pixelSize: 5,
                                                                                polygon: false,
                                                                                pathOptions: {color : '#000000',
                                                                                      stroke: true}})}
                                                         ]}).addTo(outmap);
      } // plotRoute


      if (rlines[trailnum-1] == -1){
        function getRoute(){
          return new Promise(function(resolve,reject) {
            $.ajax(
                {
                  type : 'POST',
                  url : "/button/display_route",
                  contentType: "application/json;charset=UTF-8",
                  dataType:'json',
                  data    : JSON.stringify( { "val" : trailnum } ),
                  success : function(data)
                  {
                    if (data !=null)
                    {
                       resolve(data);
                    }
                  },/*success : function() {}*/
                error : function(err){
                  reject(err);
                } /* error */
              });/*$.ajax*/
            }); /* promise */
          } /* getRoute() */


          getRoute().then(function(data){
            rlines[trailnum-1] = data;
            plotRoute(trailnum-1);
          }).catch(function(err) {
            console.log("ERROR IN GET ROUTE ", err, trailnum);
          })
      } else {
        // already got
        console.log("displayRoute: displaying already gotten route");
        plotRoute(trailnum-1);
      }



    } /* displayRoute */

    function clearMap() {

        for (i in rline_layer){

          if (rline_layer[i] != -1){
            try{
              outmap.removeLayer(rline_layer[i]);
              outmap.removeLayer(rline_dec[i]);

              // maybe just save / persist these to replot from line directly
              rline_layer[i] = -1;
              rline_dec[i]   = -1;
            } catch(e){
              console.log('problem removing rline layer',i, e);
            }
          }
        }

        for(i in outmap._layers) {
            if(outmap._layers[i]._path != undefined) {
                try {
                    outmap.removeLayer(outmap._layers[i]);
                }
                catch(e) {
                    console.log("problem with " + e + outmap._layers[i]);
                }
            }
        }


      var res = displayTrailsLMAP(trail_points, outmap)
      i///f('then' in res){
        //res.then( function(data){
          //trail_points = data;
        //})
      //}
      //console.log('TPSIZE2: ',trail_points.length);
    }

    //console.log('TPSIZE3: ',trail_points.length);
    var res = displayTrailsLMAP(trail_points, outmap);
    //if('then' in res){
    //  res.then( function(data){
  //      trail_points = data;
  //    })
    //}
    </script>

    <footer class="w3-container w3-padding-64 w3-center w3-opacity">
    <div class="w3-container w3-black w3-center w3-opacity w3-padding-64">
      <p>By using PlanIt-Trails, the user accepts all liability for anything that may occur during an activity inspired by or following the generated routes.
         PlanIt-Trails does not guarantee that the underlying trail data is up to date or accurate, nor that the recommended trails are
         safe to travel upon. Always check local land-use restrictions and potential closures before hitting the trails.
         Be smart! Be safe! Leave no trace! And have fun! </p>      
     <p>@Copyright 2020, Andrew Emerick. <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
       Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a></p>
    </footer>


   <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
   <script src="static/js/bootstrap.min.js"></script>

  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="static/js/bootstrap.min.js"></script>
  </body>
</html>
